# ShiftScheduler_JS - 智能排班系统2

基于浏览器的智能排班配置工具，用于侦测排班需求的自动化管理。

## 📋 项目概述

### 核心功能
- 🎯 **自动化排班**：通过算法自动生成满足各种约束条件的排班方案
- 📊 **数据管理**：支持人员信息、休假需求、排班配置的统一管理
- 🔄 **版本控制**：支持配置历史记录、快照保存和恢复
- 📱 **离线运行**：使用本地资源（Tailwind CSS、SheetJS、SQL.js），无需网络连接
- 💾 **数据持久化**：基于IndexedDB的本地存储，支持JSON导入导出

### 技术架构
- **前端框架**: 原生 JavaScript + HTML5 + CSS3
- **UI框架**: Tailwind CSS（本地化）
- **数据处理**: SheetJS (xlsx) 用于Excel/CSV导入导出
- **数据存储**: IndexedDB（浏览器本地数据库）
- **数据持久化**: JSON文件导出/导入
- **开发环境**: Node.js HTTP服务器（用于本地开发）

## 🚀 快速开始

### 环境要求
- Node.js（用于启动本地开发服务器）
- 现代浏览器（支持IndexedDB、ES6+）

### 本地资源说明

项目使用本地资源以确保离线运行，无需联网加载：

1. **Tailwind CSS** (`libs/tailwindcss.js`)
   - 如果本地文件不存在，会自动回退到CDN
   
2. **SheetJS (xlsx)** (`libs/xlsx.full.min.js`)
   - 用于Excel/CSV文件的导入导出
   - 如果本地文件不存在，会自动回退到CDN

3. **SQL.js** (`libs/sql-wasm.js` 和 `libs/sql-wasm.wasm`)
   - 用于数据库操作（当前项目主要使用IndexedDB）

### 启动服务器

**Windows PowerShell:**
```powershell
.\start-server.ps1
```

**Windows CMD:**
```cmd
start-server.bat
```

**手动启动:**
```bash
node server.js
```

服务器将在 `http://localhost:8000` 启动。

### 使用流程

1. **导入人员数据** → 上传Excel/CSV文件，包含人员信息
2. **配置排班周期** → 设置排班周期的开始和结束日期（默认每月26号至下月25号）
3. **配置法定休息日** → 设置法定节假日和调休情况
4. **录入个性化休假需求** → 为每个员工标记个性化休假需求
5. **生成排班** → 运行排班算法生成排班方案（待实现）
6. **导出Excel** → 导出排班结果为Excel文件（待实现）

## 📁 项目结构

```
ShiftScheduler_JS/
├── index.html                 # 主页面，包含UI框架和脚本加载
├── server.js                  # Node.js HTTP服务器
├── css/
│   └── style.css              # 自定义样式
├── js/
│   ├── app.js                 # 主应用逻辑（事件绑定、界面交互）
│   ├── state.js               # 状态管理模块
│   ├── db.js                  # IndexedDB封装（数据持久化）
│   ├── dataLoader.js          # Excel/CSV解析与导入
│   ├── staffManager.js        # 人员配置管理
│   ├── vacationManager.js     # 个性化需求配置管理
│   ├── validators.js          # 规则校验
│   ├── calendar/              # 日期处理模块
│   │   ├── dateCalculator.js
│   │   ├── holidayManager.js
│   │   ├── lunarHolidays.js
│   │   └── restDayManager.js
│   ├── managers/              # 管理器模块
│   │   ├── viewManager.js
│   │   ├── ruleConfigManager.js
│   │   └── schedulePeriodManager.js
│   ├── filters/               # 筛选模块
│   │   └── staffFilter.js
│   ├── renderers/             # 渲染器模块
│   │   └── scheduleTableRenderer.js
│   ├── rules/                  # 规则模块
│   │   ├── schedulingRules.js
│   │   ├── dayShiftRules.js
│   │   └── nightShiftRules.js
│   ├── solvers/               # 排班算法（待实现）
│   │   ├── cspSolver.js       # CSP约束求解（空文件）
│   │   └── nightShift.js      # 夜班排班算法（空文件）
│   └── utils/                 # 工具函数模块
│       ├── dateUtils.js
│       ├── statusUtils.js
│       ├── dialogUtils.js
│       ├── scheduleLockManager.js
│       └── flowController.js
├── libs/                      # 本地化资源
│   ├── tailwindcss.js
│   ├── xlsx.full.min.js
│   ├── sql-wasm.js
│   └── sql-wasm.wasm
└── database/                  # 数据存储目录
    └── shiftscheduler.json    # 导出的JSON数据文件
```

## ✅ 已完成功能

### 1. 数据管理模块 ✅ (100%)
- **人员数据导入**: Excel/CSV文件解析、列映射、数据标准化
- **人员配置管理**: 创建、编辑、删除、激活、复制、重命名配置
- **配置版本管理**: 历史版本记录、快照保存
- **积分公式配置**: 自定义积分计算公式、批量重算积分
- **数据导出**: 导出人员列表为Excel

### 2. 个性化需求管理模块 ✅ (100%)
- **需求配置管理**: 创建、激活、复制、删除、重命名需求配置
- **交互式需求录入**: 点击单元格切换休假需求
- **规则校验**: 实时校验并显示错误提示（红色高亮）
- **规则配置**: 可配置的休息日规则（上限天数、周末上限）
- **自动保存**: 操作自动保存到IndexedDB

### 3. 排班周期配置模块 ✅ (100%)
- **自动周期计算**: 根据当前日期自动选择排班周期（26号-25号）
- **手动调整**: 支持手动调整开始和结束日期
- **法定休息日配置**: 交互式日历表，支持切换休息日
- **节假日显示**: 法定节假日在第一行显示

### 4. 数据持久化模块 ✅ (100%)
- **IndexedDB存储**: 所有数据保存到浏览器本地数据库
- **JSON导出/导入**: 支持整体导出为JSON文件并导入
- **自动保存**: 关键操作自动保存
- **数据恢复**: 启动时自动从浏览器或文件恢复数据

### 5. UI界面模块 ✅ (100%)
- **多视图切换**: 排班周期管理、排班展示、人员管理、个性化休假、排班规则配置
- **响应式设计**: 使用Tailwind CSS构建现代化UI
- **交互式表格**: 支持内联编辑、点击切换
- **状态提示**: 实时状态显示和错误提示

## ❌ 未完成功能

### 1. 排班算法核心模块 ❌ (0%)
**未实现功能**：
- **夜班排班算法** (`js/solvers/nightShift.js` - 空文件)
  - ❌ 连续性大夜安排（男4女3）
  - ❌ 生理期/哺乳期禁夜班
  - ❌ 大夜天数平均分配
  - ❌ 上月大夜补偿逻辑
  
- **白班排班算法** (`js/solvers/cspSolver.js` - 空文件)
  - ❌ 技能匹配约束（网、天、微）
  - ❌ 需求数量/地域匹配
  - ❌ CSP约束求解
  
- **排班顺序处理** (`js/app.js` - `handleGenerateSchedule`)
  - ❌ 个性化休假需求优先
  - ❌ 基础休息需求规则
  - ❌ 夜班需求规则
  - ❌ 白班排班约束

### 2. 排班结果导出模块 ❌ (0%)
**未实现功能**：
- ❌ Excel导出：`handleExportExcel` 仅弹窗提示，未实现实际导出逻辑
- ❌ 排班结果展示：未实现排班结果的表格展示

### 3. 数据完善模块 ⚠️ (50%)
**待完善功能**：
- ⚠️ **节假日数据源**: `getHolidays` 函数为简化示例，部分年份硬编码，需要可靠的节假日/调休数据源
- ⚠️ **周末调休逻辑**: 需要进一步完善调休判断和处理
- ⚠️ **节假休息天数平均分配**: 未实现节假日休息天数的平均分配算法
- ⚠️ **积分分配应用**: 积分公式已配置，但排班算法中未使用

## 📊 项目完成度

**总体完成度：约60%**

| 模块 | 完成度 | 状态 |
|------|--------|------|
| 数据管理模块 | 100% | ✅ |
| 个性化需求管理 | 100% | ✅ |
| 排班周期配置 | 100% | ✅ |
| 数据持久化 | 100% | ✅ |
| UI界面 | 100% | ✅ |
| 排班算法核心 | 0% | ❌ |
| 排班结果导出 | 0% | ❌ |
| 数据完善 | 50% | ⚠️ |

## 🔧 核心代码模块说明

### 状态管理 (`js/state.js`)
- **Store对象**: 集中管理应用状态
- **状态结构**: 
  - `staffDataHistory`: 人员数据历史记录
  - `staffConfigs`: 人员配置快照数组
  - `requestConfigs`: 个性化需求配置快照数组
  - `scheduleConfig`: 排班周期配置
  - `restDays`: 法定休息日配置
  - `finalSchedule`: 最终排班结果（待生成）
- **持久化**: 与IndexedDB集成，支持自动保存和恢复

### 数据持久化 (`js/db.js`)
- **DB对象**: IndexedDB封装
- **对象存储**: 
  - `staffConfigs`: 人员配置
  - `requestConfigs`: 需求配置
  - `scheduleConfig`: 排班配置
  - `restDays`: 休息日配置
  - `restDayRules`: 休息日规则配置
- **导入导出**: 支持JSON文件格式

### 人员管理 (`js/staffManager.js`)
- **StaffManager对象**: 人员配置管理
- **核心功能**: CRUD操作、内联编辑、积分公式配置
- **配置管理**: 多配置版本管理、激活、复制、删除

### 需求管理 (`js/vacationManager.js`)
- **RequestManager对象**: 个性化需求配置管理（从 `vacationManager.js` 导出到 `window.RequestManager`）
- **核心功能**: 需求配置CRUD、交互式表格、规则校验
- **自动保存**: 操作自动保存到IndexedDB
- **注意**: `RequestManager` 不是独立文件，而是 `vacationManager.js` 中定义的 `RequestManagerImpl` 对象，通过 `Object.assign(window.RequestManager, RequestManagerImpl)` 挂载到全局

### 规则校验 (`js/validators.js`)
- **Validators对象**: 业务规则校验
- **校验规则**: 
  - 指定休息日上限（默认3天）
  - 周末休息日上限（默认2天）
  - 可配置规则值

## 📝 排班规则说明

### 基础休息需求规则
1. 指定休息日一般不可超过3天，且周末不可超过2天（一般规则，可以打破）
2. 全月休息日天数满足当前周期的法定休息日天数 >=（即前面的当周期总休假日）
3. 节假（元旦、清明、五一、端午、中秋），原则上保证每个员工的总节假休息天数平均
4. 春节、国庆的假期中根据前一年的对应的春节、国庆的上班天数产出积分，积分高休息多

### 夜班需求规则
1. 依照每个人安排一次连续性的大夜，每次大夜原则上男4，女3
2. 前面指定了生理期的时候，生理期禁止排夜班时间段（上or下）
3. 哺乳期，孕妇不排大夜
4. 人力满足的情况下，部分人的部分轮次适当减少一天大夜
5. 如果上个月大夜时间为4天，本个月减少大夜天数的人有限安排上个月4天的人
6. 优先将全年的大夜天数拉平均每人，按照性别，当月是否需要安排

### 白班排班约束
- 技能匹配约束（网、天、微）
- 需求数量/地域匹配
- CSP约束满足问题求解

### 排班顺序
满足个性化休假需求 → 满足基础休息需求规则 → 夜班需求规则 → 白班的排办约束

## 🐛 已知问题

1. **节假日数据硬编码**
   - 问题：`getHolidays` 函数为简化示例，部分年份硬编码
   - 影响：跨年或未来年份的节假日可能不准确
   - 建议：使用农历转换库或节假日API

2. **排班算法文件为空**
   - 问题：`js/solvers/cspSolver.js` 和 `js/solvers/nightShift.js` 为空文件
   - 影响：无法生成排班结果
   - 建议：优先实现核心排班算法

3. **部分业务规则未应用**
   - 问题：节假平均分配、积分分配等规则未在算法中应用
   - 影响：排班结果可能不符合业务规则
   - 建议：在排班算法中集成这些规则

4. **缺少排班结果展示**
   - 问题：排班结果无法在UI中查看
   - 影响：用户无法验证排班结果
   - 建议：实现排班结果展示和导出功能

## 🎯 下一步开发计划

### 优先级P0（核心功能）
1. **实现夜班排班算法** (`js/solvers/nightShift.js`)
   - 连续性大夜安排（男性4天，女性3天）
   - 生理期时间段禁止排夜班
   - 哺乳期、孕妇不排大夜
   - 大夜天数平均分配
   - 上月大夜补偿逻辑

2. **实现白班排班算法** (`js/solvers/cspSolver.js`)
   - 技能匹配约束（网、天、微）
   - 需求数量匹配
   - CSP约束满足问题求解

3. **实现排班顺序处理** (`js/app.js` - `handleGenerateSchedule`)
   - 满足个性化休假需求（优先保证）
   - 满足基础休息需求规则
   - 调用夜班排班算法
   - 调用白班排班算法
   - 整合最终排班结果

### 优先级P1（重要功能）
4. **完善节假日数据源**
   - 使用农历转换库（如 `lunar-javascript`）
   - 支持春节、端午、中秋的农历日期转换
   - 支持调休数据（周末调休）

5. **实现排班结果导出**
   - 生成Excel文件（使用SheetJS）
   - 表格格式设计（第一行日期，第一列人员信息）
   - 样式设置（表头固定、不同班次颜色、节假日高亮）

6. **完善基础休息需求规则**
   - 节假休息天数平均分配算法
   - 春节/国庆积分分配应用

## 📚 相关文档

- `预先设计要求.md` - 原始需求文档
- `BUGFIX_REPORT.md` - 问题修复记录
- `TEST_REPORT.md` - 功能测试报告

## 🔄 更新日志

### 2025-01-XX
- 创建项目简介文档
- 整理功能点拆解
- 制定未来规划
- 列出Todo列表

---

**文档维护者**: 开发团队  
**最后更新**: 2025-01-XX  
**文档版本**: v1.0

